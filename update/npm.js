"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const child_process_1 = require("child_process");
const fs_1 = require("fs");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const url = require("url");
const RegistryClient = require('npm-registry-client');
const npmPackageJsonCache = new Map();
const npmConfigOptionCache = new Map();
function getNpmConfigOption(option, scope, tryWithoutScope) {
    if (scope && tryWithoutScope) {
        return rxjs_1.concat(getNpmConfigOption(option, scope), getNpmConfigOption(option)).pipe(operators_1.filter(result => !!result), operators_1.defaultIfEmpty(), operators_1.first());
    }
    const fullOption = `${scope ? scope + ':' : ''}${option}`;
    let value = npmConfigOptionCache.get(fullOption);
    if (value) {
        return value;
    }
    const subject = new rxjs_1.ReplaySubject(1);
    try {
        child_process_1.exec(`npm get ${fullOption}`, (error, data) => {
            if (error) {
                subject.next();
            }
            else {
                data = data.trim();
                if (!data || data === 'undefined' || data === 'null') {
                    subject.next();
                }
                else {
                    subject.next(data);
                }
            }
            subject.complete();
        });
    }
    catch (_a) {
        subject.next();
        subject.complete();
    }
    value = subject.asObservable();
    npmConfigOptionCache.set(fullOption, value);
    return value;
}
function getNpmClientSslOptions(strictSsl, cafile) {
    const sslOptions = {};
    if (strictSsl === 'false') {
        sslOptions.strict = false;
    }
    else if (strictSsl === 'true') {
        sslOptions.strict = true;
    }
    if (cafile) {
        sslOptions.ca = fs_1.readFileSync(cafile);
    }
    return sslOptions;
}
/**
 * Get the NPM repository's package.json for a package. This is p
 * @param {string} packageName The package name to fetch.
 * @param {string} registryUrl The NPM Registry URL to use.
 * @param {LoggerApi} logger A logger instance to log debug information.
 * @returns An observable that will put the pacakge.json content.
 * @private
 */
function getNpmPackageJson(packageName, registryUrl, logger) {
    const scope = packageName.startsWith('@') ? packageName.split('/')[0] : undefined;
    return (registryUrl ? rxjs_1.of(registryUrl) : getNpmConfigOption('registry', scope, true)).pipe(operators_1.map(partialUrl => {
        if (!partialUrl) {
            partialUrl = 'https://registry.npmjs.org/';
        }
        const partial = url.parse(partialUrl);
        let fullUrl = new url.URL(`http://${partial.host}/${packageName.replace(/\//g, '%2F')}`);
        try {
            const registry = new url.URL(partialUrl);
            registry.pathname = (registry.pathname || '')
                .replace(/\/?$/, '/' + packageName.replace(/\//g, '%2F'));
            fullUrl = new url.URL(url.format(registry));
        }
        catch (_a) { }
        logger.debug(`Getting package.json from '${packageName}' (url: ${JSON.stringify(fullUrl)})...`);
        return fullUrl.toString();
    }), operators_1.concatMap(fullUrl => {
        let maybeRequest = npmPackageJsonCache.get(fullUrl);
        if (maybeRequest) {
            return maybeRequest;
        }
        return rxjs_1.concat(getNpmConfigOption('proxy'), getNpmConfigOption('https-proxy'), getNpmConfigOption('strict-ssl'), getNpmConfigOption('cafile')).pipe(operators_1.toArray(), operators_1.concatMap(options => {
            const subject = new rxjs_1.ReplaySubject(1);
            const sslOptions = getNpmClientSslOptions(options[2], options[3]);
            const client = new RegistryClient({
                proxy: {
                    http: options[0],
                    https: options[1],
                },
                ssl: sslOptions,
            });
            client.log.level = 'silent';
            const params = {
                timeout: 30000,
            };
            client.get(fullUrl, params, (error, data) => {
                if (error) {
                    subject.error(error);
                }
                subject.next(data);
                subject.complete();
            });
            maybeRequest = subject.asObservable();
            npmPackageJsonCache.set(fullUrl.toString(), maybeRequest);
            return maybeRequest;
        }));
    }));
}
exports.getNpmPackageJson = getNpmPackageJson;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibnBtLmpzIiwic291cmNlUm9vdCI6Ii4vIiwic291cmNlcyI6WyJwYWNrYWdlcy9zY2hlbWF0aWNzL3VwZGF0ZS91cGRhdGUvbnBtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBUUEsaURBQXFDO0FBQ3JDLDJCQUFrQztBQUNsQywrQkFBNkQ7QUFDN0QsOENBQXdGO0FBQ3hGLDJCQUEyQjtBQUczQixNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FBQztBQUV0RCxNQUFNLG1CQUFtQixHQUFHLElBQUksR0FBRyxFQUFnRCxDQUFDO0FBQ3BGLE1BQU0sb0JBQW9CLEdBQUcsSUFBSSxHQUFHLEVBQTBDLENBQUM7QUFFL0UsNEJBQ0UsTUFBYyxFQUNkLEtBQWMsRUFDZCxlQUF5QjtJQUV6QixFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUksZUFBZSxDQUFDLENBQUMsQ0FBQztRQUM3QixNQUFNLENBQUMsYUFBTSxDQUNYLGtCQUFrQixDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsRUFDakMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLENBQzNCLENBQUMsSUFBSSxDQUNKLGtCQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQzFCLDBCQUFjLEVBQUUsRUFDaEIsaUJBQUssRUFBRSxDQUNSLENBQUM7SUFDSixDQUFDO0lBRUQsTUFBTSxVQUFVLEdBQUcsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQztJQUUxRCxJQUFJLEtBQUssR0FBRyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDakQsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUNWLE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUQsTUFBTSxPQUFPLEdBQUcsSUFBSSxvQkFBYSxDQUFxQixD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LEdBQUcsc0JBQXNCLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRWxFLE1BQU0sTUFBTSxHQUFHLElBQUksY0FBYyxDQUFDO2dCQUNoQyxLQUFLLEVBQUU7b0JBQ0wsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUM7b0JBQ2hCLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO2lCQUNsQjtnQkFDRCxHQUFHLEVBQUUsVUFBVTthQUNoQixDQUFDLENBQUM7WUFDSCxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssR0FBRyxRQUFRLENBQUM7WUFDNUIsTUFBTSxNQUFNLEdBQUc7Z0JBQ2IsT0FBTyxFQUFFLEtBQUs7YUFDZixDQUFDO1lBRUYsTUFBTSxDQUFDLEdBQUcsQ0FDUixPQUFPLEVBQ1AsTUFBTSxFQUNOLENBQUMsS0FBYSxFQUFFLElBQThCLEVBQUUsRUFBRTtnQkFDbEQsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztvQkFDVixPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUN2QixDQUFDO2dCQUVELE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ25CLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNyQixDQUFDLENBQUMsQ0FBQztZQUVILFlBQVksR0FBRyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDdEMsbUJBQW1CLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsRUFBRSxZQUFZLENBQUMsQ0FBQztZQUUxRCxNQUFNLENBQUMsWUFBWSxDQUFDO1FBQ3RCLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDLENBQUMsQ0FDSCxDQUFDO0FBRUosQ0FBQztBQWhGRCw4Q0FnRkMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5pbXBvcnQgeyBsb2dnaW5nIH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L2NvcmUnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IHsgcmVhZEZpbGVTeW5jIH0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgUmVwbGF5U3ViamVjdCwgY29uY2F0LCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY29uY2F0TWFwLCBkZWZhdWx0SWZFbXB0eSwgZmlsdGVyLCBmaXJzdCwgbWFwLCB0b0FycmF5IH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0ICogYXMgdXJsIGZyb20gJ3VybCc7XG5pbXBvcnQgeyBOcG1SZXBvc2l0b3J5UGFja2FnZUpzb24gfSBmcm9tICcuL25wbS1wYWNrYWdlLWpzb24nO1xuXG5jb25zdCBSZWdpc3RyeUNsaWVudCA9IHJlcXVpcmUoJ25wbS1yZWdpc3RyeS1jbGllbnQnKTtcblxuY29uc3QgbnBtUGFja2FnZUpzb25DYWNoZSA9IG5ldyBNYXA8c3RyaW5nLCBPYnNlcnZhYmxlPE5wbVJlcG9zaXRvcnlQYWNrYWdlSnNvbj4+KCk7XG5jb25zdCBucG1Db25maWdPcHRpb25DYWNoZSA9IG5ldyBNYXA8c3RyaW5nLCBPYnNlcnZhYmxlPHN0cmluZyB8IHVuZGVmaW5lZD4+KCk7XG5cbmZ1bmN0aW9uIGdldE5wbUNvbmZpZ09wdGlvbihcbiAgb3B0aW9uOiBzdHJpbmcsXG4gIHNjb3BlPzogc3RyaW5nLFxuICB0cnlXaXRob3V0U2NvcGU/OiBib29sZWFuLFxuKTogT2JzZXJ2YWJsZTxzdHJpbmcgfCB1bmRlZmluZWQ+IHtcbiAgaWYgKHNjb3BlICYmIHRyeVdpdGhvdXRTY29wZSkge1xuICAgIHJldHVybiBjb25jYXQoXG4gICAgICBnZXROcG1Db25maWdPcHRpb24ob3B0aW9uLCBzY29wZSksXG4gICAgICBnZXROcG1Db25maWdPcHRpb24ob3B0aW9uKSxcbiAgICApLnBpcGUoXG4gICAgICBmaWx0ZXIocmVzdWx0ID0+ICEhcmVzdWx0KSxcbiAgICAgIGRlZmF1bHRJZkVtcHR5KCksXG4gICAgICBmaXJzdCgpLFxuICAgICk7XG4gIH1cblxuICBjb25zdCBmdWxsT3B0aW9uID0gYCR7c2NvcGUgPyBzY29wZSArICc6JyA6ICcnfSR7b3B0aW9ufWA7XG5cbiAgbGV0IHZhbHVlID0gbnBtQ29uZmlnT3B0aW9uQ2FjaGUuZ2V0KGZ1bGxPcHRpb24pO1xuICBpZiAodmFsdWUpIHtcbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cblxuICBjb25zdCBzdWJqZWN0ID0gbmV3IFJlcGxheVN1YmplY3Q8c3RyaW5nIHwgdW5kZWZpbmVkPigxKTtcblxuICB0cnkge1xuICAgIGV4ZWMoYG5wbSBnZXQgJHtmdWxsT3B0aW9ufWAsIChlcnJvciwgZGF0YSkgPT4ge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIHN1YmplY3QubmV4dCgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZGF0YSA9IGRhdGEudHJpbSgpO1xuICAgICAgICBpZiAoIWRhdGEgfHwgZGF0YSA9PT0gJ3VuZGVmaW5lZCcgfHwgZGF0YSA9PT0gJ251bGwnKSB7XG4gICAgICAgICAgc3ViamVjdC5uZXh0KCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc3ViamVjdC5uZXh0KGRhdGEpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHN1YmplY3QuY29tcGxldGUoKTtcbiAgICB9KTtcbiAgfSBjYXRjaCB7XG4gICAgc3ViamVjdC5uZXh0KCk7XG4gICAgc3ViamVjdC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgdmFsdWUgPSBzdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICBucG1Db25maWdPcHRpb25DYWNoZS5zZXQoZnVsbE9wdGlvbiwgdmFsdWUpO1xuXG4gIHJldHVybiB2YWx1ZTtcbn1cblxuZnVuY3Rpb24gZ2V0TnBtQ2xpZW50U3NsT3B0aW9ucyhzdHJpY3RTc2w/OiBzdHJpbmcsIGNhZmlsZT86IHN0cmluZykge1xuICBjb25zdCBzc2xPcHRpb25zOiB7IHN0cmljdD86IGJvb2xlYW4sIGNhPzogQnVmZmVyIH0gPSB7fTtcblxuICBpZiAoc3RyaWN0U3NsID09PSAnZmFsc2UnKSB7XG4gICAgc3NsT3B0aW9ucy5zdHJpY3QgPSBmYWxzZTtcbiAgfSBlbHNlIGlmIChzdHJpY3RTc2wgPT09ICd0cnVlJykge1xuICAgIHNzbE9wdGlvbnMuc3RyaWN0ID0gdHJ1ZTtcbiAgfVxuXG4gIGlmIChjYWZpbGUpIHtcbiAgICBzc2xPcHRpb25zLmNhID0gcmVhZEZpbGVTeW5jKGNhZmlsZSk7XG4gIH1cblxuICByZXR1cm4gc3NsT3B0aW9ucztcbn1cblxuLyoqXG4gKiBHZXQgdGhlIE5QTSByZXBvc2l0b3J5J3MgcGFja2FnZS5qc29uIGZvciBhIHBhY2thZ2UuIFRoaXMgaXMgcFxuICogQHBhcmFtIHtzdHJpbmd9IHBhY2thZ2VOYW1lIFRoZSBwYWNrYWdlIG5hbWUgdG8gZmV0Y2guXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVnaXN0cnlVcmwgVGhlIE5QTSBSZWdpc3RyeSBVUkwgdG8gdXNlLlxuICogQHBhcmFtIHtMb2dnZXJBcGl9IGxvZ2dlciBBIGxvZ2dlciBpbnN0YW5jZSB0byBsb2cgZGVidWcgaW5mb3JtYXRpb24uXG4gKiBAcmV0dXJucyBBbiBvYnNlcnZhYmxlIHRoYXQgd2lsbCBwdXQgdGhlIHBhY2FrZ2UuanNvbiBjb250ZW50LlxuICogQHByaXZhdGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldE5wbVBhY2thZ2VKc29uKFxuICBwYWNrYWdlTmFtZTogc3RyaW5nLFxuICByZWdpc3RyeVVybDogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICBsb2dnZXI6IGxvZ2dpbmcuTG9nZ2VyQXBpLFxuKTogT2JzZXJ2YWJsZTxQYXJ0aWFsPE5wbVJlcG9zaXRvcnlQYWNrYWdlSnNvbj4+IHtcbiAgY29uc3Qgc2NvcGUgPSBwYWNrYWdlTmFtZS5zdGFydHNXaXRoKCdAJykgPyBwYWNrYWdlTmFtZS5zcGxpdCgnLycpWzBdIDogdW5kZWZpbmVkO1xuXG4gIHJldHVybiAoXG4gICAgcmVnaXN0cnlVcmwgPyBvZihyZWdpc3RyeVVybCkgOiBnZXROcG1Db25maWdPcHRpb24oJ3JlZ2lzdHJ5Jywgc2NvcGUsIHRydWUpXG4gICkucGlwZShcbiAgICBtYXAocGFydGlhbFVybCA9PiB7XG4gICAgICBpZiAoIXBhcnRpYWxVcmwpIHtcbiAgICAgICAgcGFydGlhbFVybCA9ICdodHRwczovL3JlZ2lzdHJ5Lm5wbWpzLm9yZy8nO1xuICAgICAgfVxuICAgICAgY29uc3QgcGFydGlhbCA9IHVybC5wYXJzZShwYXJ0aWFsVXJsKTtcbiAgICAgIGxldCBmdWxsVXJsID0gbmV3IHVybC5VUkwoYGh0dHA6Ly8ke3BhcnRpYWwuaG9zdH0vJHtwYWNrYWdlTmFtZS5yZXBsYWNlKC9cXC8vZywgJyUyRicpfWApO1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcmVnaXN0cnkgPSBuZXcgdXJsLlVSTChwYXJ0aWFsVXJsKTtcbiAgICAgICAgcmVnaXN0cnkucGF0aG5hbWUgPSAocmVnaXN0cnkucGF0aG5hbWUgfHwgJycpXG4gICAgICAgICAgICAucmVwbGFjZSgvXFwvPyQvLCAnLycgKyBwYWNrYWdlTmFtZS5yZXBsYWNlKC9cXC8vZywgJyUyRicpKTtcbiAgICAgICAgZnVsbFVybCA9IG5ldyB1cmwuVVJMKHVybC5mb3JtYXQocmVnaXN0cnkpKTtcbiAgICAgIH0gY2F0Y2gge31cblxuICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICBgR2V0dGluZyBwYWNrYWdlLmpzb24gZnJvbSAnJHtwYWNrYWdlTmFtZX0nICh1cmw6ICR7SlNPTi5zdHJpbmdpZnkoZnVsbFVybCl9KS4uLmAsXG4gICAgICApO1xuXG4gICAgICByZXR1cm4gZnVsbFVybC50b1N0cmluZygpO1xuICAgIH0pLFxuICAgIGNvbmNhdE1hcChmdWxsVXJsID0+IHtcbiAgICAgIGxldCBtYXliZVJlcXVlc3QgPSBucG1QYWNrYWdlSnNvbkNhY2hlLmdldChmdWxsVXJsKTtcbiAgICAgIGlmIChtYXliZVJlcXVlc3QpIHtcbiAgICAgICAgcmV0dXJuIG1heWJlUmVxdWVzdDtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGNvbmNhdChcbiAgICAgICAgZ2V0TnBtQ29uZmlnT3B0aW9uKCdwcm94eScpLFxuICAgICAgICBnZXROcG1Db25maWdPcHRpb24oJ2h0dHBzLXByb3h5JyksXG4gICAgICAgIGdldE5wbUNvbmZpZ09wdGlvbignc3RyaWN0LXNzbCcpLFxuICAgICAgICBnZXROcG1Db25maWdPcHRpb24oJ2NhZmlsZScpLFxuICAgICAgKS5waXBlKFxuICAgICAgICB0b0FycmF5KCksXG4gICAgICAgIGNvbmNhdE1hcChvcHRpb25zID0+IHtcbiAgICAgICAgICBjb25zdCBzdWJqZWN0ID0gbmV3IFJlcGxheVN1YmplY3Q8TnBtUmVwb3NpdG9yeVBhY2thZ2VKc29uPigxKTtcblxuICAgICAgICAgIGNvbnN0IHNzbE9wdGlvbnMgPSBnZXROcG1DbGllbnRTc2xPcHRpb25zKG9wdGlvbnNbMl0sIG9wdGlvbnNbM10pO1xuXG4gICAgICAgICAgY29uc3QgY2xpZW50ID0gbmV3IFJlZ2lzdHJ5Q2xpZW50KHtcbiAgICAgICAgICAgIHByb3h5OiB7XG4gICAgICAgICAgICAgIGh0dHA6IG9wdGlvbnNbMF0sXG4gICAgICAgICAgICAgIGh0dHBzOiBvcHRpb25zWzFdLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNzbDogc3NsT3B0aW9ucyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBjbGllbnQubG9nLmxldmVsID0gJ3NpbGVudCc7XG4gICAgICAgICAgY29uc3QgcGFyYW1zID0ge1xuICAgICAgICAgICAgdGltZW91dDogMzAwMDAsXG4gICAgICAgICAgfTtcblxuICAgICAgICAgIGNsaWVudC5nZXQoXG4gICAgICAgICAgICBmdWxsVXJsLFxuICAgICAgICAgICAgcGFyYW1zLFxuICAgICAgICAgICAgKGVycm9yOiBvYmplY3QsIGRhdGE6IE5wbVJlcG9zaXRvcnlQYWNrYWdlSnNvbikgPT4ge1xuICAgICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICAgIHN1YmplY3QuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzdWJqZWN0Lm5leHQoZGF0YSk7XG4gICAgICAgICAgICBzdWJqZWN0LmNvbXBsZXRlKCk7XG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBtYXliZVJlcXVlc3QgPSBzdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICAgICAgICAgIG5wbVBhY2thZ2VKc29uQ2FjaGUuc2V0KGZ1bGxVcmwudG9TdHJpbmcoKSwgbWF5YmVSZXF1ZXN0KTtcblxuICAgICAgICAgIHJldHVybiBtYXliZVJlcXVlc3Q7XG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9KSxcbiAgKTtcblxufVxuIl19